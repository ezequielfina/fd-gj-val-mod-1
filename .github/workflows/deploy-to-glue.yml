name: Despliegue de Glue Job

on:
  push:
    branches: [main]
    paths:
      - 'scripts/**'
      - '.github/workflows/**'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-to-aws:
    runs-on: ubuntu-latest
    env:
      GLUE_JOB_NAME: fd-gj-mod-1
      SCRIPT_BUCKET: aws-glue-assets-520692692841-us-east-1
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Configurar credenciales de AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 1. Subir Script a ruta de TESTING
      - name: Subir Script de Test a S3
        run: aws s3 cp scripts/fd-gj-mod-1.py s3://${{ env.SCRIPT_BUCKET }}/testing/test-version.py

      # 2. Apuntar el Glue Job al script de TESTING
      - name: Configurar Glue Job en modo Test
        run: |
          ROLE_ARN=$(aws glue get-job --job-name ${{ env.GLUE_JOB_NAME }} --query 'Job.Role' --output text)
          
          aws glue update-job \
            --job-name ${{ env.GLUE_JOB_NAME }} \
            --job-update "Role=$ROLE_ARN,DefaultArguments={'--file_key':'s3://franq-bucket/raw/e8ae6d9c-29e4-4fe4-b505-b472b6ddc5a1/year=2025/month=06/091acf95-e0db-4927-b678-f1ca0b11f6dd.xlsx','--additional-python-modules':'awswrangler,openpyxl'},Command={Name=glueetl,ScriptLocation=s3://${{ env.SCRIPT_BUCKET }}/testing/test-version.py,PythonVersion=3}"

      # 3. Correr Glue Test Job (Nota: Asegurate que 'archivo_prueba' sea .xlsx si usas read_excel)
      - name: Correr Glue Test Job
        id: run-glue
        run: |
          RUN_ID=$(aws glue start-job-run --job-name ${{ env.GLUE_JOB_NAME }} --arguments='--file_key="s3://franq-bucket/raw/e8ae6d9c-29e4-4fe4-b505-b472b6ddc5a1/year=2025/month=06/091acf95-e0db-4927-b678-f1ca0b11f6dd.xlsx"' --query 'JobRunId' --output text)
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      # 4. Esperar resultados (Igual que tu script original)
      - name: Wait for Test Result
        run: |
          while true; do
            STATUS=$(aws glue get-job-run --job-name ${{ env.GLUE_JOB_NAME }} --run-id ${{ env.RUN_ID }} --query 'JobRun.JobRunState' --output text)
            if [ "$STATUS" == "SUCCEEDED" ]; then
              echo "‚úÖ Test pasado con √©xito"
              break
            elif [ "$STATUS" == "FAILED" ] || [ "$STATUS" == "STOPPED" ] || [ "$STATUS" == "TIMEOUT" ]; then
              echo "‚ùå El test fall√≥ con estado: $STATUS"
              # Importante: Mostrar logs de error si falla
              aws glue get-job-run --job-name ${{ env.GLUE_JOB_NAME }} --run-id ${{ env.RUN_ID }} --query 'JobRun.ErrorMessage'
              exit 1
            fi
            echo "Esperando a Glue... (Status: $STATUS)"
            sleep 15
          done

      # 5. Promote to Production (Copiar archivo y Actualizar Job)
      - name: Promote to Production
        if: success()
        run: |
          echo "Promoviendo script..."
          # A. Copiar el archivo f√≠sico a la carpeta de scripts productivos
          aws s3 cp s3://${{ env.SCRIPT_BUCKET }}/testing/test-version.py s3://${{ env.SCRIPT_BUCKET }}/scripts/fd-gj-mod-1.py
          
          # B. Re-apuntar el Glue Job al script de PRODUCCI√ìN
          aws glue update-job \
            --job-name ${{ env.GLUE_JOB_NAME }} \
            --job-update "Command={Name=glueetl,ScriptLocation=s3://${{ env.SCRIPT_BUCKET }}/scripts/fd-gj-mod-1.py,PythonVersion=3}"
            
          echo "üöÄ Script promovido y Job actualizado a producci√≥n correctamente"