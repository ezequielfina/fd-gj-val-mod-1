name: Despliegue de Glue Job (Seguro)

on:
  push:
    branches: [main]
    paths:
      - '../../scripts/script.py'
      - '.github/workflows/**'
      - 'pyproject.toml'
  workflow_dispatch:

jobs:
  deploy-to-aws:
    runs-on: ubuntu-latest

    env:
      GLUE_JOB_NAME: fd-gj-mod-1
      SCRIPT_BUCKET: aws-glue-assets-520692692841-us-east-1
      PROD_SCRIPT_KEY: scripts/script.py
      TEST_SCRIPT_KEY: testing/test-version.py
      # Bucket de datos para las pruebas
      DATA_BUCKET: franq-bucket

    steps:
      # 1Ô∏è‚É£ Descargar el c√≥digo del repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Autenticarse en AWS
      - name: Configurar AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3Ô∏è‚É£ Subir el nuevo script a la ruta de TESTING
      - name: Subir Script a S3 (Testing)
        run: |
          aws s3 cp scripts/script.py \
            s3://${{ env.SCRIPT_BUCKET }}/${{ env.TEST_SCRIPT_KEY }}

      # 4Ô∏è‚É£ Configurar y Ejecutar Test
      - name: Configurar y Ejecutar Test
        id: run-glue
        run: |
          # A. Obtenemos el Role para no perderlo
          ROLE_ARN=$(aws glue get-job --job-name ${{ env.GLUE_JOB_NAME }} --query 'Job.Role' --output text)

          # B. Forzamos al Job a apuntar al archivo de TESTING y configuramos librer√≠as
          aws glue update-job \
            --job-name ${{ env.GLUE_JOB_NAME }} \
            --job-update "{
              \"Role\": \"$ROLE_ARN\",
              \"Command\": {
                \"Name\": \"pythonshell\",
                \"ScriptLocation\": \"s3://${{ env.SCRIPT_BUCKET }}/${{ env.TEST_SCRIPT_KEY }}\",
                \"PythonVersion\": \"3.9\"
              },
              \"DefaultArguments\": {
                \"--additional-python-modules\": \"aws-sdk-pandas==3.4.0,openpyxl==3.1.2\"
              }
            }"

          # C. Ahora s√≠, arrancamos la ejecuci√≥n enviando solo el file_key
          RUN_ID=$(aws glue start-job-run \
            --job-name ${{ env.GLUE_JOB_NAME }} \
            --arguments '{"--file_key": "raw/e8ae6d9c-29e4-4fe4-b505-b472b6ddc5a1/year=2025/month=06/091acf95-e0db-4927-b678-f1ca0b11f6dd.xlsx"}' \
            --query 'JobRunId' --output text)

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      # 5Ô∏è‚É£ Monitorear el estado de la ejecuci√≥n
      - name: Esperar resultado del Test
        run: |
          while true; do
            STATUS=$(aws glue get-job-run \
              --job-name ${{ env.GLUE_JOB_NAME }} \
              --run-id ${{ env.RUN_ID }} \
              --query 'JobRun.JobRunState' --output text)

            if [ "$STATUS" = "SUCCEEDED" ]; then
              echo "‚úÖ El test pas√≥ correctamente"
              break
            elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "STOPPED" ] || [ "$STATUS" = "TIMEOUT" ]; then
              echo "‚ùå El test fall√≥ con estado: $STATUS"
              # Obtenemos el mensaje de error real de Glue para el log de GitHub
              aws glue get-job-run --job-name ${{ env.GLUE_JOB_NAME }} --run-id ${{ env.RUN_ID }} --query 'JobRun.ErrorMessage'
              exit 1
            fi

            echo "‚è≥ Esperando a Glue... ($STATUS)"
            sleep 20
          done

      # 6Ô∏è‚É£ Backup + Promote a PROD
      - name: Promote a Producci√≥n
        if: success()
        run: |
          echo "üöÄ Promoviendo script a PROD..."
          aws s3 cp \
            s3://${{ env.SCRIPT_BUCKET }}/${{ env.TEST_SCRIPT_KEY }} \
            s3://${{ env.SCRIPT_BUCKET }}/${{ env.PROD_SCRIPT_KEY }}

          echo "‚öôÔ∏è Re-configurando Job para usar ruta de Producci√≥n..."
          ROLE_ARN=$(aws glue get-job --job-name ${{ env.GLUE_JOB_NAME }} --query 'Job.Role' --output text)
          
          aws glue update-job \
            --job-name ${{ env.GLUE_JOB_NAME }} \
            --job-update "{
              \"Role\": \"$ROLE_ARN\",
              \"Command\": {
                \"Name\": \"pythonshell\",
                \"ScriptLocation\": \"s3://${{ env.SCRIPT_BUCKET }}/${{ env.PROD_SCRIPT_KEY }}\",
                \"PythonVersion\": \"3.9\"
              },
              \"DefaultArguments\": {
                \"--additional-python-modules\": \"aws-sdk-pandas==3.4.0,openpyxl==3.1.2\"
              }
            }"
          echo "‚úÖ Producci√≥n actualizada correctamente"