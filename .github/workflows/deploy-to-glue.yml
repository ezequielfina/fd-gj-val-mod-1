name: Despliegue de Glue Job (Seguro)

on:
  push:
    branches: [main]
    paths:
      - 'scripts/fd-gj-mod-1.py'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  deploy-to-aws:
    runs-on: ubuntu-latest

    env:
      GLUE_JOB_NAME: fd-gj-mod-1
      SCRIPT_BUCKET: aws-glue-assets-520692692841-us-east-1
      PROD_SCRIPT_KEY: scripts/fd-gj-mod-1.py
      TEST_SCRIPT_KEY: testing/test-version.py
      # Bucket de datos para las pruebas
      DATA_BUCKET: franq-bucket

    steps:
      # 1Ô∏è‚É£ Descargar el c√≥digo del repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Autenticarse en AWS
      - name: Configurar AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3Ô∏è‚É£ Subir el nuevo script a la ruta de TESTING
      - name: Subir Script a S3 (Testing)
        run: |
          aws s3 cp scripts/fd-gj-mod-1.py \
            s3://${{ env.SCRIPT_BUCKET }}/${{ env.TEST_SCRIPT_KEY }}

      # 4Ô∏è‚É£ Ejecutar el Job apuntando al script de TEST (Override)
      # Aqu√≠ forzamos a Glue a usar el script nuevo y a instalar las librer√≠as
      - name: Ejecutar Glue Test
        id: run-glue
        run: |
          RUN_ID=$(aws glue start-job-run \
            --job-name ${{ env.GLUE_JOB_NAME }} \
            --command '{"Name": "pythonshell", "ScriptLocation": "s3://${{ env.SCRIPT_BUCKET }}/${{ env.TEST_SCRIPT_KEY }}", "PythonVersion": "3.9"}' \
            --arguments '{
              "--file_key": "raw/e8ae6d9c-29e4-4fe4-b505-b472b6ddc5a1/year=2025/month=06/091acf95-e0db-4927-b678-f1ca0b11f6dd.xlsx",
              "--additional-python-modules": "aws-sdk-pandas==3.4.0,openpyxl==3.1.2"
            }' \
            --query 'JobRunId' --output text)

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      # 5Ô∏è‚É£ Monitorear el estado de la ejecuci√≥n
      - name: Esperar resultado del Test
        run: |
          while true; do
            STATUS=$(aws glue get-job-run \
              --job-name ${{ env.GLUE_JOB_NAME }} \
              --run-id ${{ env.RUN_ID }} \
              --query 'JobRun.JobRunState' --output text)

            if [ "$STATUS" = "SUCCEEDED" ]; then
              echo "‚úÖ El test pas√≥ correctamente"
              break
            elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "STOPPED" ] || [ "$STATUS" = "TIMEOUT" ]; then
              echo "‚ùå El test fall√≥ con estado: $STATUS"
              # Obtenemos el mensaje de error real de Glue para el log de GitHub
              aws glue get-job-run --job-name ${{ env.GLUE_JOB_NAME }} --run-id ${{ env.RUN_ID }} --query 'JobRun.ErrorMessage'
              exit 1
            fi

            echo "‚è≥ Esperando a Glue... ($STATUS)"
            sleep 20
          done

      # 6Ô∏è‚É£ Si el test pas√≥: Backup de la versi√≥n anterior y Promoci√≥n a PROD
      - name: Promoci√≥n a Producci√≥n
        if: success()
        run: |
          echo "üì¶ Generando backup de la versi√≥n anterior en S3..."
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          aws s3 cp \
            s3://${{ env.SCRIPT_BUCKET }}/${{ env.PROD_SCRIPT_KEY }} \
            s3://${{ env.SCRIPT_BUCKET }}/scripts/backups/fd-gj-mod-1-$TIMESTAMP.py || echo "No hab√≠a versi√≥n previa."

          echo "üöÄ Copiando script validado a la ruta de producci√≥n..."
          aws s3 cp \
            s3://${{ env.SCRIPT_BUCKET }}/${{ env.TEST_SCRIPT_KEY }} \
            s3://${{ env.SCRIPT_BUCKET }}/${{ env.PROD_SCRIPT_KEY }}

          echo "‚öôÔ∏è Actualizando configuraci√≥n permanente del Glue Job..."
          # Obtenemos el Role ARN actual para no perderlo al actualizar
          ROLE_ARN=$(aws glue get-job --job-name ${{ env.GLUE_JOB_NAME }} --query 'Job.Role' --output text)
          
          aws glue update-job \
            --job-name ${{ env.GLUE_JOB_NAME }} \
            --job-update "{
              \"Role\": \"$ROLE_ARN\",
              \"Command\": {
                \"Name\": \"pythonshell\",
                \"ScriptLocation\": \"s3://${{ env.SCRIPT_BUCKET }}/${{ env.PROD_SCRIPT_KEY }}\",
                \"PythonVersion\": \"3.9\"
              },
              \"DefaultArguments\": {
                \"--additional-python-modules\": \"aws-sdk-pandas==3.4.0,openpyxl==3.1.2\"
              },
              \"MaxCapacity\": 0.0625
            }"

          echo "‚úÖ Producci√≥n actualizada y configurada correctamente."