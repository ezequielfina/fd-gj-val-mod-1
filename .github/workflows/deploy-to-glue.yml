name: Despliegue de Glue Job

on:
  push:
    branches: [main]
    paths:
      - 'scripts/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  deploy-to-aws:
    runs-on: ubuntu-latest

    env:
      GLUE_JOB_NAME: fd-gj-mod-1
      SCRIPT_BUCKET: aws-glue-assets-520692692841-us-east-1
      PROD_SCRIPT_KEY: scripts/fd-gj-mod-1.py
      TEST_SCRIPT_KEY: testing/test-version.py

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ AWS credentials
      - name: Configurar AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3Ô∏è‚É£ Subir script de TEST
      - name: Subir Script TEST
        run: |
          aws s3 cp scripts/fd-gj-mod-1.py \
            s3://${{ env.SCRIPT_BUCKET }}/${{ env.TEST_SCRIPT_KEY }}

      # 4Ô∏è‚É£ Ejecutar Glue Job (TEST)
      - name: Ejecutar Glue Test
        run: |
          RUN_ID=$(aws glue start-job-run \
            --job-name ${{ env.GLUE_JOB_NAME }} \
            --arguments '{
              "--file_key": "raw/e8ae6d9c-29e4-4fe4-b505-b472b6ddc5a1/year=2025/month=06/091acf95-e0db-4927-b678-f1ca0b11f6dd.xlsx"
            }' \
            --query 'JobRunId' --output text)

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      # 5Ô∏è‚É£ Esperar resultado del TEST
      - name: Esperar resultado del Test
        run: |
          while true; do
            STATUS=$(aws glue get-job-run \
              --job-name ${{ env.GLUE_JOB_NAME }} \
              --run-id ${{ env.RUN_ID }} \
              --query 'JobRun.JobRunState' --output text)

            if [ "$STATUS" = "SUCCEEDED" ]; then
              echo "‚úÖ Test OK"
              break
            elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "STOPPED" ] || [ "$STATUS" = "TIMEOUT" ]; then
              echo "‚ùå Test fall√≥ con estado: $STATUS"
              aws glue get-job-run \
                --job-name ${{ env.GLUE_JOB_NAME }} \
                --run-id ${{ env.RUN_ID }} \
                --query 'JobRun.ErrorMessage'
              exit 1
            fi

            echo "‚è≥ Esperando Glue... ($STATUS)"
            sleep 15
          done

      # 6Ô∏è‚É£ Backup + Promote a PROD
      - name: Promote a Producci√≥n
        if: success()
        run: |
          echo "üì¶ Backup del script actual (si existe)..."
          aws s3 cp \
            s3://${{ env.SCRIPT_BUCKET }}/${{ env.PROD_SCRIPT_KEY }} \
            s3://${{ env.SCRIPT_BUCKET }}/scripts/backup/fd-gj-mod-1-prev.py \
            || echo "No existe versi√≥n previa, contin√∫o"

          echo "üöÄ Promoviendo script a PROD..."
          aws s3 cp \
            s3://${{ env.SCRIPT_BUCKET }}/${{ env.TEST_SCRIPT_KEY }} \
            s3://${{ env.SCRIPT_BUCKET }}/${{ env.PROD_SCRIPT_KEY }}

          echo "‚úÖ Producci√≥n actualizada correctamente"
