name: Despliegue de Glue Job

on:
  push:
    branches: [main]
    paths:
      - 'scripts/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  deploy-to-aws:
    runs-on: ubuntu-latest
    env:
      GLUE_JOB_NAME: fd-gj-mod-1
      SCRIPT_BUCKET: aws-glue-assets-520692692841-us-east-1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 1Ô∏è‚É£ Subir script de test
      - name: Subir Script TEST
        run: |
          aws s3 cp scripts/fd-gj-mod-1.py \
          s3://${{ env.SCRIPT_BUCKET }}/testing/test-version.py

      # 2Ô∏è‚É£ Configurar Glue Job
      - name: Configurar Glue Job
        run: |
          ROLE_ARN=$(aws glue get-job \
            --job-name ${{ env.GLUE_JOB_NAME }} \
            --query 'Job.Role' --output text)

          aws glue update-job \
            --job-name ${{ env.GLUE_JOB_NAME }} \
            --job-update "{
              \"Role\": \"$ROLE_ARN\",
              \"Command\": {
                \"Name\": \"pythonshell\",
                \"ScriptLocation\": \"s3://${{ env.SCRIPT_BUCKET }}/testing/test-version.py\",
                \"PythonVersion\": \"3.9\"
              },
              \"DefaultArguments\": {
                \"--additional-python-modules\": \"awswrangler==3.4.0,openpyxl==3.1.2\",
                \"--BUCKET\": \"franq-bucket\"
              },
              \"MaxCapacity\": 0.0625
            }"

      # 3Ô∏è‚É£ Ejecutar test
      - name: Ejecutar Glue Test
        run: |
          RUN_ID=$(aws glue start-job-run \
            --job-name ${{ env.GLUE_JOB_NAME }} \
            --arguments '{
              "--file_key": "raw/e8ae6d9c-29e4-4fe4-b505-b472b6ddc5a1/year=2025/month=06/test.xlsx"
            }' \
            --query 'JobRunId' --output text)

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      # 4Ô∏è‚É£ Esperar resultado
      - name: Esperar resultado
        run: |
          while true; do
            STATUS=$(aws glue get-job-run \
              --job-name ${{ env.GLUE_JOB_NAME }} \
              --run-id ${{ env.RUN_ID }} \
              --query 'JobRun.JobRunState' --output text)

            if [ "$STATUS" == "SUCCEEDED" ]; then
              echo "‚úÖ Test OK"
              break
            elif [ "$STATUS" == "FAILED" ] || [ "$STATUS" == "STOPPED" ]; then
              echo "‚ùå Glue fall√≥"
              aws glue get-job-run \
                --job-name ${{ env.GLUE_JOB_NAME }} \
                --run-id ${{ env.RUN_ID }} \
                --query 'JobRun.ErrorMessage'
              exit 1
            fi

            echo "‚è≥ Esperando... ($STATUS)"
            sleep 15
          done

      # 5Ô∏è‚É£ Promote
      - name: Promote to PROD
        if: success()
        run: |
          aws s3 cp \
            s3://${{ env.SCRIPT_BUCKET }}/testing/test-version.py \
            s3://${{ env.SCRIPT_BUCKET }}/scripts/fd-gj-mod-1.py

          aws glue update-job \
            --job-name ${{ env.GLUE_JOB_NAME }} \
            --job-update "Command={Name=pythonshell,ScriptLocation=s3://${{ env.SCRIPT_BUCKET }}/scripts/fd-gj-mod-1.py,PythonVersion=3}"

          echo "üöÄ Producci√≥n actualizada"